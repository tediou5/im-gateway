# Infra Work Organization

Author: qians

Date: 2023/4/28

Version: 0.0.1

## 方向及优先级(由高到低)

1. [ ] 先跑起来.
   - [x] 连接创建后先进行鉴权.
   - [x] 接入websocket.
   - [x] 消息转发至相关服务器.
      - [x] 私聊和创建群的消息通过广播推送.
      - [x] 用户加入新群后更新Router信息.
   - [ ] 持续跟进.

2. 单体性能优化
   - [ ] 推送群消息时, 额外用户无法通过Router找到.
      - 推送群消息时, 如果额外用户按照私聊处理, 但并未及时从在线状态缓存中清除, 会导致重复推送.
   - [ ] 推送消息时, 每个用户真正推送时才进行编码, 每条消息1: N. 需要优化.
   - [ ] 推送消息时, 现在每个平台都复用TCP的协议和事件, 只能说凑合用, 但是对性能有影响. 需要优化.
   - [ ] 推送消息时, 群用户列表的获取. 如果每次都从Redis读取会出现巨量重复(同一个群的n条消息需要反复查询Redis N次).
      - [ ] 维护和更新(Join, Leave)群组用户在线状态的内存缓存.
          - [ ] 当Join一个不存在的群(创建群)时, 无法通过Router找到相关Link Service. 只能通过广播方式下发, 用户加入后再更新相关Router信息.
      - [ ] 群组用户在线状态由内存转移至持久化存储(硬盘).
   - [ ] 群消息多合一批量推送(聚合时需要解决消息乱序和错漏问题).
   - [ ] 内存使用优化, 保证程序长期稳定运行.
   - [ ] 连接管理优化, 优化群发消息时成员列表的获取方式.
   - [ ] Redis状态更新和离线(目前只实现了服务器上线时去Redis登记, 没有进行状态更新和离线, 不影响消息推送, 但会带来额外的服务器负担).
   - [ ] 服务运行负载监控及限流方案设计实施.

3. 集群方案实现
   - [ ] 基于conhash集群设计, 实现精确推送(目前基于Kafka管理多节点, 使用广播进行推送, 存在大量冗余).
   - [ ] 基于conhash集群设计, 进行动态负载均衡.
   - [ ] 集群健康状况以及负载监控. 对高负载服务器限流, 降级, 维持正常服务运行.
   - [ ] 集群下的群用户在线状态管理.

为了实现10w人超级大群的推送需求, 共需两个集群来共同完成推送任务(Proxy, Link)