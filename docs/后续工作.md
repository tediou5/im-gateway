# Infra Work Organization

Author: qians

Date: 2023/5/15

Version: 0.0.2

## 方向及优先级(由高到低)

1. [x] 先跑起来.
   - [ ] 持续跟进.
   - [ ] 目前登录鉴权使用HTTP请求, 性能和并发量都比较低, 需要优化.
   - [ ] 协议添加Disconnect方法, 业务端可控制连接状态.
   - [x] 鉴权返回等待时间过久.
   - [x] 连接创建后先进行鉴权.
   - [x] 继续测试排除流量问题导致的推送慢.
     - 目前推送慢的原因是消息体增大导致单条处理时间增加造成的.
   - [x] 优化上下游交互, 减少推送服务器处理量.
   - [x] 接入websocket.
     - [x] websocket暂时移出, 协议优化后重新加入.
   - [x] 消息转发至相关服务器.
      - [x] 私聊和创建群的消息通过广播推送.
      - [x] 用户加入新群后更新Router信息.

2. [ ] 弱网处理
   - [ ] 数据拆分: 一条拆多条.

3. [ ] 网络传输优化
   - [ ] 出口流量卡网卡出不去
    1. [ ] 挂载多网卡
    2. [ ] 多网卡bond实现网卡聚合, 负载均衡
   - [ ] 压缩报文减小出口流量

4. [ ] 限流分流
   - [ ] 连接数控制
   - [ ] 转发请求量控制
   - [ ] 单个用户请求频率控制
   - [ ] 健康状况健康
     - [ ] 当前系统内待推送消息数量
     - [ ] 内存使用
     - [ ] cpu使用
     - [x] 总连接数
     - [x] 每秒处理消息数(不确定是否完成转发, 只是完成处理, 等待推送)
     - [x] 每秒实际推送数量(只统计成功)

5. [ ] 设计文档
   - [ ] 推送时大群成员列表获取
   - [ ] 弱网
   - [x] 限流分流
   - [x] 流量过大解决方法
   - [x] 压缩技术选型

6. [ ] 集群方案实现
   - [ ] 基于conhash集群设计, 实现精确推送(目前基于Kafka管理多节点, 使用广播进行推送, 存在大量冗余).
   - [ ] 基于conhash集群设计, 进行动态负载均衡.
   - [ ] 集群健康状况以及负载监控. 对高负载服务器限流, 降级, 维持正常服务运行.
   - [ ] 集群下的群用户在线状态管理.

7. [ ] 单体性能优化
   - [ ] 内存使用优化, 保证程序长期稳定运行.
   - [ ] Redis状态更新和离线(目前只实现了服务器上线时去Redis登记, 没有进行状态更新和离线, 不影响消息推送, 但会带来额外的服务器负担).
   - [x] 禁止反复鉴权.
   - [x] Proxy协议中的Message可以更换使用HexString, 减少字节数及编解码计算量.
   - [x] Proxy协议中, Group消息可以将additional直接作为私聊消息转发, Link层不处理additional(由业务端处理了).
   - [x] 推送群消息时, 额外用户无法通过Router找到.
     - 推送群消息时, 如果额外用户按照私聊处理, 但并未及时从在线状态缓存中清除, 会导致重复推送.
   - [x] 推送消息时, 每个用户真正推送时才进行编码, 每条消息1: N. 需要优化.
   - [x] 推送消息时, 现在每个平台都复用TCP的协议和事件, 只能说凑合用, 但是对性能有影响. 需要优化.
   - [x] 推送消息时, 群用户列表的获取. 如果每次都从Redis读取会出现巨量重复(同一个群的n条消息需要反复查询Redis N次).
     - [x] 维护和更新(Join, Leave)群组用户在线状态的内存缓存.
     - [x] 当Join一个不存在的群(创建群)时, 无法通过Router找到相关Link Service. 只能通过广播方式下发, 用户加入后再更新相关Router信息.
