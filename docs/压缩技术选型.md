# IM压缩技术选型

Author: qians

Date: 2023/5/15

Version: v0.0.1

## 需求性能指标

按目前测试环境中数据, 推送服务器满载性能约为1000w每秒, 若1w人接收则每秒推送1000条, 200人接收, 则每秒推送5000条. 每个消息, 最大1800bytes, 最小301bytes,  平均1000bytes. 也就是说预估每秒最大压缩量可能为5000 * 1800bytes = 90000000bytes, 近似估计为90M. 客户端解压缩量等同.
同时由于每个消息会被扩散推送N份, 所以压缩比的收益率为(N * 压缩比).

## 可选技术性能指标

压缩核心指标共两个指标, 压缩比(压缩前/压缩后, 越高越好)和吞吐量(每秒压缩解压缩量, 越高越好).

目前市面上比较主流的压缩算法有4种: zstd, zlib, lz4, snappy.
性能指标如下(数据来自各自官网):

| Compressor name | 压缩比 |     压缩    |    解压缩   |
| --------------- | ------| -----------| ---------- |
| zstd 1.5.1 -1   | 2.887 |   530 MB/s |  1700 MB/s |
| zlib 1.2.11 -1  | 2.743 |    95 MB/s |   400 MB/s |
| lz4 1.9.3       | 2.101 |   740 MB/s |  4500 MB/s |
| snappy 1.1.9    | 2.073 |   550 MB/s |  1750 MB/s |

对比可以得出: snappy和zlib在这两项指标中全面落后, 不考虑.
lz4压缩时吞吐量约为zstd的150%, 解压缩时吞吐量约为zstd的260%.
zstd压缩比为lz4的137%.

**考虑到我们的预计吞吐量远远小于各算法的性能指标, 且本项目压缩比收益率更高. 因此我倾向于使用zstd算法**
