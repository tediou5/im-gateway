# 连接层控制协议

Author: qians

Date: 2023/5/24

Version: v0.0.1

## 控制协议

| ControlHeader     | (optional)Length      | (optional)TraceId   | Body   |
| ----------------- | --------------------- | ------------------- | ------ |
| 控制协议头(1字节) | 可选的Body长度(2字节) | 可选的追踪ID(8字节) | 协议体 |

- 控制协议头: 8位(1字节)

| 1位网络质量标识位 | 1位心跳标识位     | 1位ACK标识位    | 1位弱网包标识位 | 4位数量标识位                             |
| ----------------- | ----------------- | --------------- | --------------- | ----------------------------------------- |
| 0:正常, 1:质量差  | 0: 关闭, 1:心跳包 | 0: 关闭, 1:开启 | 0: 关闭, 1:开启 | 0-15, 表示弱网包拆分数量或者批量ACK的数量 |

- Body

一共有两种Body, 分别是ACK消息的ACKBody和普通消息ContentBody

  - ACK: 当ACK标识位开启, 其他标识位关闭则为ACK消息

    | ACK包内容(长度为ACK数量 * id长度) |
    | --------------------------------- |
    | 多个ACK的TraceId拼成一个buffer串  |

- 普通消息: 当所有标识位都关闭时, 则为普通消息. 普通消息需要Length和TraceId字段

    | 16位(两字节)Length        | 64位(8字节)TraceId                  | Content    |
    | ------------------------- | ----------------------------------- | ---------- |
    | 能够表示0-65535之间的长度 | 雪花id, 用作连接层追踪消息是否被ACK | 业务消息体 |

### 示例

- ACK消息

对于ACK消息即开启ACK标识位并关闭其他, 头中数量标识为1.

```rust
// 二进制头
0 0 1 0 0 0 0 1 = 33
  |
[33, to_bytes(trace_id)]
```

- 普通消息

对于ACK消息即开启ACK标识位并关闭其他, 头中数量标识为1.

```rust
// 二进制
0 0 0 0 0 0 0 1 = 1
 |
[1, to_bytes(len), to_bytes(trace_id), to_bytes(content)]
```

- 心跳消息

对于心跳消息即开启心跳标识位并关闭其他, 头中数量标识为1.

```rust
// 二进制
0 1 0 0 0 0 0 1 = 1
 |
[65, to_bytes(len), to_bytes(trace_id), to_bytes(content)]
```
