# Business - Proxy - TCP数据交换流程及需求对接

Author: qians
Date: 2023/4/25
Version: 0.0.1

## 需求

目前, Client连接TCP服务器, 并向TCP提交请求.

- TCP需要完成连接后的鉴权.

    1. 我需要鉴权逻辑和相关接口信息.
       鉴权逻辑：
       1. 从tcp通道解析出鉴权消息，文档：消息协议调整版1.11.docx,鉴权消息里含有：token：用户token，appId：应用id.
            - example hex:

            ```hex
            000001013761376236633263633566653466303738393132616234653066323131663262000000006447a78b7b2264617461223a207b22746f6b656e223a202265794a68624763694f694a49557a49314e694a392e65794a7a59577830496a6f694d6e4134536e6868633049694c434a77615734694f69497a5a4463354d6a4a694f545a6d596a6b305a444d774f475a684e474531596d59314e57493459574d784d434973496d467763456c6b496a6f6955315a50515568696248416966512e72336a726b4f655f685536766a6b46456571596e637a537a624f61623250546a63774d54736c6a66726951222c20226170704964223a202253564f4148626c70222c2022706c6174666f726d223a2022415050227d2c202270726f746f636f6c223a2022436f6e6e656374227d
            ```

       2. 鉴权api地址: <http://192.168.0.92:8080/v1/rest/merchant/user/parseToken>，接口参数说明api文档.

       3. 返回参数中code=“0”，表示鉴权通过，鉴权通过后rust保存tcp通道等信息，之后发送USER_BASE_INFO通知消息给tcp客户端，USER_BASE_INFO通知消息格式参加：消息协议调整版1.11.docx.
            - example hex:

            ```hex
            7b2264617461223a207b22636861744964223a2022222c20226d7367466f726d6174223a202254455854222c20226d73674964223a20223261626665366266303331333461356238613831623262326531373236643461222c20226e6f7469636554797065223a2022555345525f424153455f494e464f222c2022626f6479223a20227b5c2261707049645c223a5c2253564f4148626c705c222c5c226176617461725c223a5c226176617461725c222c5c226973426f745c223a66616c73652c5c226e69636b6e616d655c223a5c227465737420757365725c222c5c2270696e5c223a5c2232663734393634616132383734663066383032613761323638653061653632375c222c5c227365785c223a66616c73652c5c227569645c223a5c22515245314c4f55425c227d222c2022636861744d736754797065223a20224e6f74696365222c202266726f6d4964223a20223266373439363461613238373466306638303261376132363865306165363237222c20226170704964223a202253564f4148626c70222c20226368617454797065223a202250726976617465222c202274696d657374616d70223a20313638323431373837323337367d2c202270726f746f636f6c223a20224d657373616765227d 
            ```

            - example utf-8

            ```json
            {"data": 
                {"chatId": "",
                "msgFormat": "TEXT",
                "msgId": "2abfe6bf03134a5b8a81b2b2e1726d4a",
                "noticeType": "USER_BASE_INFO",
                "body":"{\"appId\":\"SVOAHblp\",\"avatar\":\"avatar\",\"isBot\":false,\"nickname\":\"test user\",\"pin\":\"2f74964aa2874f0f802a7a268e0ae627\",\"sex\":false,\"uid\":\"QRE1LOUB\"}",
                "chatMsgType": "Notice",
                "fromId": "2f74964aa2874f0f802a7a268e0ae627",
                "appId": "SVOAHblp",
                "chatType": "Private",
                "timestamp": 1682417872376
                },
            "protocol": "Message"}
            ```

    2. 鉴权后, 我需要加载用户元数据(群列表)用于加速群消息转发, 请告知我相关接口信息.
       鉴权api地址：<http://192.168.0.92:8080/v1/rest/merchant/user/parseToken>会返回用户群信息，接口参数说明参见api文档
    3. 鉴权完成后, 数据加载完成, 用户被TCP Service正式接受, 请告知我是否需要向用户确认.
       不通知

- 鉴权通过后, TCP通过Kafka将请求提交给Business Service.

    1. Topic名及消息格式.
       im-session-link
    2. 我是否需要预处理数据(例如拆包), 如果需要请告知我预处理相关逻辑.
       拆，参见文档：消息协议调整版1.11.docx

- Business Service处理完成后, 可通过Proxy将数据推送给TCP Service.

    Proxy集群完成按群的批数据聚合(同群的数据应该由同个Proxy Service处理, 以避免消息错序)和TCP路由寻址精准投递(减少不必要的RPC调用和处理).

    1. 为了将来升级方便, 第一版每个Proxy服务都会提供出HTTP接口. 调用方请求任意Proxy Service后由此Service解析请求, 并转发到正确的Proxy上. 优势是调用更加方便, 且无需关心集群内部复杂性. 劣势是每次请求会有一个额外的RPC调用, 在高负载情况下可能会加重Service的压力. 后期应该提供出相应的集群SDK供调用方使用.
    2. Proxy协议暂时沿用TCP协议, 后期可以增加更多的控制选项. 包括压缩, 加密, 推送速度, 流量控制等.

## API

Author: wl

Date: 2023/4/25

Version: 0.0.1

### 鉴权

地址：<http://192.168.0.92:8080/v1/rest/merchant/user/parseToken>

请求方式：post application/x-www-form-urlencoded

请求参数:

| 参数名   | 参数类型 | 说明      | 是否必填 |
| -------- | -------- | --------- | -------- |
| appId    | String   | 应用id    | 是       |
| token    | String   | 用户token | 是       |
| platform | String   | 用户平台  | 是       |

响应数据:

```json
{
    "code":"0",
    "data":{
        "baseInfo":{
            "appId":"SVOAHblp",
            "avatar":"avatar",
            "isBot":false,
            "nickname":"testUserName",
            "pin":"2f74964aa2874f0f802a7a268e0ae627",
            "sex":false,
            "uid":"QRE1LOUB"
        },
        "chats":["cc_1","cc_2"]
    },
    "message":"success"
}
```
