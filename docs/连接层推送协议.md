# Link Server Protocol

Author: qians

Date: 2023/4/25

Version: 0.0.1

## LinkProtocol

本协议只用于Link Infra的行为, 与业务逻辑无关. 在原则上, 本协议应该尽可能精简和通用.
并为将来的压缩, 加密等行为留出空间.

### 私聊

| 参数名  | 参数类型           | 说明     | 是否必填 |
| ------- | ------------------ | -------- | -------- |
| recv_id | Vec<String>        | 接收者id | 是       |
| content | HexString<Message> | 发送内容 | 是       |

- example

    ```json
    [["recvxx"], "a5ba55c5ca5ba5b5a"]
    ```

### 群聊

| 参数名     | 参数类型           | 说明         | 是否必填 |
| ---------- | ------------------ | ------------ | -------- |
| chat_id    | String             | 目的群id     | 是       |
| exclusions | Vec\<String\>      | 排除用户列表 | 是(可空) |
| content    | HexString<Message> | 发送内容     | 是       |

- example

    ```json
    ["recvxx", ["exclusion"], "455a4545545a45a"]
    ```

#### 群聊状态更新

| 参数名 | 参数类型                    | 说明 | 是否必填 |
| ------ | --------------------------- | ---- | -------- |
| action | Action(Join, Leave, Notice) | 动作 | 是       |

Join | Leave

| 参数名  | 参数类型      | 说明         | 是否必填 |
| ------- | ------------- | ------------ | -------- |
| chat_id | String        | 目的群id     | 是       |
| users   | Vec\<String\> | 相关用户列表 | 是       |

Notice

| 参数名  | 参数类型           | 说明         | 是否必填 |
| ------- | ------------------ | ------------ | -------- |
| chat_id | String             | 目的群id     | 是       |
| notice  | HexString<Message> | 相关用户列表 | 是       |

- join example

    ```json
    "join": ["cc_1", ["uu1", "uu2"]]
    ```

- leave example

    ```json
    "leave": ["cc_2", ["uu3", "uu4"]]
    ```

- notice example

    ```json
    "notice": ["cc_3", "455a4545545a45a"]
    ```

## Proxy

Proxy对外提供HTTP接口供Business Service调用并将数据推送给对应TCP Service.

### Push

请求地址: post /message

- Request

  | 字段     | 说明     | 类型         | 备注       | 是否必填 |
  | -------- | -------- | ------------ | ---------- | -------- |
  | protocol | 协议报文 | LinkProtocol | 按JSON即可 | 是       |

  - 示例
  
    ```json
    [
        ["recvxx"], "7b2264617461223a207b22636861744964223a2022222c20226d7367466f726d6174223a202254455854222c20226d73674964223a20223261626665366266303331333461356238613831623262326531373236643461222c20226e6f7469636554797065223a2022555345525f424153455f494e464f222c2022626f6479223a20227b5c2261707049645c223a5c2253564f4148626c705c222c5c226176617461725c223a5c226176617461725c222c5c226973426f745c223a66616c73652c5c226e69636b6e616d655c223a5c227465737420757365725c222c5c2270696e5c223a5c2232663734393634616132383734663066383032613761323638653061653632375c222c5c227365785c223a66616c73652c5c227569645c223a5c22515245314c4f55425c227d222c2022636861744d736754797065223a20224e6f74696365222c202266726f6d4964223a20223266373439363461613238373466306638303261376132363865306165363237222c20226170704964223a202253564f4148626c70222c20226368617454797065223a202250726976617465222c202274696d657374616d70223a20313638323431373837323337367d2c202270726f746f636f6c223a20224d657373616765227d"
    ]
    ```

- Response

  返回参数：

  | 字段   | 说明   | 类型 | 备注                   | 是否必填 |
  | ------ | ------ | ---- | ---------------------- | -------- |
  | status | 状态码 | Int  | 成功: 200, 已推入Kafka | 是       |

  无返回值

## 在线状态

Link服务器会在TCP读到数据时, 在Redis更新对应Pin, Value为空. 超时时间为heartbeat + 1.