- Feature: 控制协议添加断线控制标识
- Start Date: 2023/5/29
- Version: 0.0.2
# Summary

在控制协议头中, 当后8位全为0, 则标识服务器主动断开. 来控制客户端在此情况断开后不再重连.
当第一位为1, 则表示服务器由于网络原因断开连接, 客户端可以重连.

# Motivation

当前场景下, 客户端断开连接后会重复尝试重新连接. 即当用户切换设备后, 旧设备被断线后会重复触发断线重连, 导致新旧设备互相争抢, 无法正常切换设备.

# Guide-level explanation

1. 当控制头为0(00000000)时, 表示服务器主动断开且不再重连的情况, 按之前的定义. 协议头0含义时表示:
`网络正常`, `非心跳包`, `非ACK包`, `非弱网包`, `数量为0`的消息. 因为不存在数量为0的消息, 因此用来表示网络正常情况下断开情况, 用户不应该重连.

1. 当控制头为128(100000000)时, 表示服务器主动断开且需要重连的情况, 按之前的定义. 协议头128含义时表示:
`网络异常`, `非心跳包`, `非ACK包`, `非弱网包`, `数量为0`的消息. 因为不存在数量为0的消息, 因此用来表示网络异常(多次重发失败, )情况下断开情况, 服务器希望用户重新连接来消除网络问题, 因此用户需要重连.

## 完整报文示例

- 服务器关闭连接消息, 不重连

对于服务器关闭连接消息即关闭所有标识位, 且头中数量标识为0. 随后是2字节长度, 之后是8字节追踪id, 最后是断开的原因的字符串.

```rust
// 二进制
0 0 0 0 0 0 0 0 = 0
 |
[0, to_bytes(len), to_bytes(trace_id), to_bytes(disconnect_reason)]
```

- 服务器关闭连接消息, 重连

对于服务器关闭连接消息即关闭所有标识位, 且头中数量标识为0. 随后是2字节长度, 之后是8字节追踪id, 最后是断开的原因的字符串.

```rust
// 二进制
1 0 0 0 0 0 0 0 = 0
 |
[128, to_bytes(len), to_bytes(trace_id), to_bytes(disconnect_reason)]
```


# Rationale and alternatives

此方案下对之前已使用的协议情况是兼容的, 并且语义上也较合理.

# Unresolved questions

对于场景来说, 实际上我应该确认用户收到此报文(ACK)才应该断开连接. 不然应不断重发直至用户确认. 但由于时间和实现的复杂度考虑, 目前只向客户端发送此报文, 随后立即断开连接. 后续应完善此流程.
