# 消息协议

Author: qians

Date: 2023/6/7

Version: v1.12

## 目录

1. 协议格式
   1. ControlHeader
      1. Length
      2. TraceId
      3. Body
   2. Content(业务消息体)
      1. Protocol
      2. ProtocolData
         1. ConnectData(连接消息)
         2. HeartbeatData(心跳消息)
         3. ResponseData(响应消息)
         4. MessageData(会话消息)
            1. ChatType
            2. ChatMsgType
            3. MsgFormat
            4. NoticeType
            5. Body
2. 常见消息样式
3. 目前存在的问题&可能的解决途径

## 协议格式

| ControlHeader     | (optional)Length                       | TraceId       | (optional)Body |
| ----------------- | -------------------------------------- | ------------- | -------------- |
| 控制协议头(1字节) | 可选的Body长度(2字节), 当ACK消息时没有 | 追踪ID(8字节) | 可选的协议体   |

### ControlHeader

| 1位网络质量标识位 | 1位心跳标识位    | 1位ACK标识位   | 1位弱网包标识位 | 3位标识位(闲置, 留作将来使用) | 1位消息体标识位                            |
| ----------------- | ---------------- | -------------- | --------------- | ----------------------------- | ------------------------------------------ |
| 0:正常, 1:质量差  | 0:关闭, 1:心跳包 | 0:关闭, 1:开启 | 0: 关闭, 1:开启 | [0, 0, 0]:闲置                | 1:正常消息, 0:系统消息(目前仅用作控制断开) |

- Length
  - 存放Body的字节长度.
  - 当ACK消息时无Length字段.
  - 长度为两字节, 使用uint16接收.
  - 标识范围为0-65535.

- TraceId
  - 使用Snowflake算法生成的单机递增唯一ID.
  - 长度为8字节, 使用uint64接收.
  - 基于毫秒时间戳生成, 当时间回滚可能会导致ID重复.

- Body
  - 消息体.
  - 字节长度为Length.
  - 当消息体标识位为1时:
    - 当ACK开启时无Body.
    - 其他情况下Body为Content(业务消息)类型.
  - 当消息体标识为0时:
    - 系统消息, 目前仅用作控制断开, Body内容为Reason(断开原因).
      - 当消息头为`0 0 0 0 0 0 0 0`时, 代表网络`正常`情况下断开, 请`停止`尝试重连.
      - 当消息头为`1 0 0 0 0 0 0 0`时, 代表网络`异常`情况下断开, 请`继续`尝试重连.

### Content(业务消息体)

业务消息体为JSON格式, 共两个顶级字段:

| 参数名   | 参数类型     | 说明                       | 是否必填 |
| -------- | ------------ | -------------------------- | -------- |
| protocol | Protocol     | 业务消息协议类型           | 是       |
| data     | ProtocolData | 每种消息对应不同的数据结构 | 是       |

#### Protocol

目前共有4种业务消息协议类型:

| 类型名   | 对应数据结构  | 说明     |
| -------- | ------------- | -------- |
| Connect  | ConnectData   | 连接消息 |
| Heart    | HeartbeatData | 心跳消息 |
| Message  | MessageData   | 会话消息 |
| Response | ResponseData  | 响应消息 |

#### ConnectData

> 连接消息, 用于建立连接时鉴权.

| 参数名   | 参数类型 | 说明 | 是否必填 |
| -------- | -------- | ---- | -------- |
| appId    | String   |      | 是       |
| token    | String   |      | 是       |
| platform | Platform |      | 是       |

- Platform

| 参数名 | 参数类型 | 说明   |
| ------ | -------- | ------ |
| Pc     | Status   | 桌面端 |
| App    | String   | 移动端 |
| Web    | String   | 网页端 |

#### HeartbeatData

> 心跳消息, 用于维持心跳, 服务端根据心跳维持用户在线.
> 注意ControlHeader中需要开启心跳.

| 参数名 | 参数类型 | 说明 | 是否必填 |
| ------ | -------- | ---- | -------- |
| status | Int      | 状态 | 否       |

#### ResponseData

> 响应消息

| 参数名    | 参数类型 | 说明     | 是否必填 |
| --------- | -------- | -------- | -------- |
| status    | Status   | 响应状态 | 是       |
| msgId     | String   | 消息id   | 是       |
| timestamp | uint64   | 时间戳   | 是       |
| errorMsg  | String   | 失败原因 | 是       |

- status

| 状态码 | 类型 | 说明                              |
| ------ | ---- | --------------------------------- |
| 200    | int  | 成功                              |
| 401    | int  | 失败(私聊:非好友, 群聊: 非群成员) |
| 403    | int  | 失败(群已禁言)                    |
| 500    | int  | 失败(服务内部异常)                |

#### MessageData

> 会话消息

| 参数名      | 参数类型    | 说明         | 是否必填 |
| ----------- | ----------- | ------------ | -------- |
| msgId       | String      | 消息id       | 是       |
| timestamp   | uint64      | 时间戳       | 是       |
| chatId      | String      | 会话id       | 是       |
| chatType    | ChatType    | 会话类型     | 是       |
| appId       | String      | 应用id       | 是       |
| fromId      | String      | 发送人pin    | 是       |
| from        | User        | 发送人信息   | 是       |
| chatMsgType | ChatMsgType | 消息类型     | 是       |
| msgFormat   | MsgFormat   | 会话消息类型 | 是       |
| noticeType  | NoticeType  | 通知消息类型 | 是       |
| sqlId       | uint64      | 消息seq      | 是       |
| body        | Body        | JSON消息体   | 是       |

- ChatType

| 类型       | 类型   | 说明   |
| ---------- | ------ | ------ |
| Private    | String | 私聊   |
| Group      | String | 普通群 |
| SuperGroup | String | 超级群 |

- ChatMsgType

| 类型    | 类型   | 说明     |
| ------- | ------ | -------- |
| Session | String | 会话消息 |
| Notice  | String | 通知消息 |

- MsgFormat

| 类型                 | 类型   | 说明           |
| -------------------- | ------ | -------------- |
| TEXT                 | String | 文本           |
| PICTURE              | String | 图片           |
| TIME                 | String | 时间           |
| CARD                 | String | 名片           |
| TRANSFER             | String | 转发           |
| VIDEO                | String | 视频           |
| AUDIO                | String | 音频           |
| LINE_VIDEO           | String | 视频通话       |
| LINE_AUDIO           | String | 音频通话       |
| REPLY                | String | @某人          |
| REPLY_SPECIAL        | String | 既有回复又有@  |
| FILE                 | String | 文件           |
| EMOJI                | String | 表情           |
| FRIEND_AGREE         | String | 好友同意       |
| Team_Create          | String | 创建群         |
| TEAM_JOIN            | String | 邀请入群       |
| TEAM_KICK            | String | 群踢人         |
| TEAM_LEAVE           | String | 退群           |
| TEAM_REMOVE          | String | 群解散         |
| TEAM_MUTE            | String | 群禁言         |
| TEAM_MUTE_CANCEL     | String | 群取消禁言     |
| TEAM_PROTECT         | String | 群成员保护     |
| TEAM_PROTECT_CANCEL  | String | 群成员保护取消 |
| TEAM_MSG_TOP         | String | 群消息置顶     |
| TEAM_MSG_TOP_OFF     | String | 群消息取消置顶 |
| TEAM_MANAGER         | String | 设置管理员     |
| TEAM_MANAGER_CANCEL  | String | 取消管理员     |
| TEAM_UPDATE          | String | 群更新         |
| TEAM_UPDATE_ANNOUNCE | String | 群公告更新     |
| SHARE_QR             | String | 分享二维码     |
| SHARE_SHORT_URL      | String | 分享短链接     |

- NoticeType

| 类型                        | 类型   | 说明                                    |
| --------------------------- | ------ | --------------------------------------- |
| FRIEND_REQUEST              | String | 请求添加好友                            |
| FRIEND_AGREE                | String | 同意添加好友                            |
| FRIEND_REFUSE               | String | 拒绝添加好友                            |
| FRIEND_DELETE               | String | 删除好友                                |
| TEAM_CREATE                 | String | 创建群                                  |
| TEAM_JOIN                   | String | 加入群聊                                |
| TEAM_KICK                   | String | 踢出群                                  |
| TEAM_REMOVE                 | String | 解散群                                  |
| TEAM_UPDATE                 | String | 修改群资料                              |
| TEAM_LEAVE                  | String | 退群                                    |
| TEAM_MUTE                   | String | 群全体禁言                              |
| TEAM_MUTE_CANCEL            | String | 群全体取消禁言                          |
| TEAM_FORBID_FRIEND          | String | 群成员禁止添加好友                      |
| TEAM_FORBID_FRIEND_CANCEL   | String | 群成员取消禁止添加好友                  |
| TEAM_INVITE                 | String | 普通群成员能否邀请他人入群              |
| TEAM_INVITE_CANCEL          | String | 取消普通群成员能否邀请他人入群          |
| TEAM_MANAGER                | String | 设置管理员                              |
| TEAM_MANAGER_CANCEL         | String | 取消设置管理员                          |
| TEAM_DELETE_ANNOUNCE        | String | 群删除公告                              |
| TEAM_UPDATE_ANNOUNCE        | String | 群公告更新                              |
| SESSION_INFO_PUSH           | String | 拉取会话列表                            |
| SESSION_LIST_DELETE         | String | 删除会话列表:私聊删除对方, 群里删除对方 |
| MANAGER_SESSION_LIST_DELETE | String | 群主/管理员删除群会话                   |
| MSG_DELETE                  | String | 删除消息:可以批量删除                   |
| DEL_NOTICE                  | String | 前端处理完通知后，通知后端进行删除      |
| TOP_ON                      | String | 群消息置顶                              |
| TOP_OFF                     | String | 群消息取消置顶                          |
| MSG_READ                    | String | 消息已读                                |
| USER_UPDATE_BASIC           | String | 好友修改基本资料信息                    |
| USER_BASE_INFO              | String | 用户tcp认证后的基本信息                 |
| CUSTOM                      | String | 自定义通知                              |

- Body
  > body是JSON类型的字符串格式，有三种类型：通知、通知类消息、会话消息
  - 通知
    - 删除通知消息

    | 参数名 | 参数类型 | 说明   | 是否必填 |
    | ------ | -------- | ------ | -------- |
    | msgId  | String   | 消息id | 是       |

    - 消息删除通知

    | 参数名 | 参数类型       | 说明       | 是否必填 |
    | ------ | -------------- | ---------- | -------- |
    | chatId | String         | 会话id     | 是       |
    | msgIds | List\<String\> | 消息id列表 | 是       |

    - 消息已读通知消息

    | 参数名 | 参数类型 | 说明          | 是否必填 |
    | ------ | -------- | ------------- | -------- |
    | seqId  | uint64   | 消息seq       | 是       |
    | fromId | String   | 消息发送人pin | 是       |

    - 消息置顶通知

    | 参数名  | 参数类型            | 说明     | 是否必填 |
    | ------- | ------------------- | -------- | -------- |
    | chatId  | String              | 会话id   | 是       |
    | msgList | List\<MessageData\> | 消息列表 | 是       |

    - 删除群公告信息

    | 参数名     | 参数类型 | 说明     | 是否必填 |
    | ---------- | -------- | -------- | -------- |
    | announceId | String   | 群公告id | 是       |

    - 群信息

    | 参数名                         | 参数类型 | 说明                 | 是否必填 |
    | ------------------------------ | -------- | -------------------- | -------- |
    | id                             | String   | 群id                 | 是       |
    | appId                          | String   | app id               | 是       |
    | tname                          | String   | 群名称               | 是       |
    | icon                           | String   | 群头像               | 是       |
    | owner                          | String   | 群主pin              | 是       |
    | announce                       | String   | 公告内容             | 是       |
    | announceTime                   | Date     | 群公告更新时间       | 是       |
    | announceId                     | String   | 群公告id             | 是       |
    | mute                           | Boolean  | 是否群禁言           | 是       |
    | forbidFriend                   | Boolean  | 是否禁止加好友       | 是       |
    | inviteAble                     | Boolean  | 是否能邀请用户进群   | 是       |
    | createTime                     | Date     | 创建时间             | 是       |
    | createTimeMilliseconds         | uint64   | 创建时间戳           | 是       |
    | updateTimeMilliseconds         | uint64   | 修改时间戳           | 是       |
    | teamUserUpdateTimeMilliseconds | uint64   | 群用户更新时间戳     | 是       |
    | canAddByQrcode                 | Boolean  | 是否能通过二维码入群 | 是       |
    | canAddMeShortLink              | Boolean  | 是否能通过短链接入群 | 是       |

    - 踢人出群通知

    | 参数名        | 参数类型       | 说明        | 是否必填 |
    | ------------- | -------------- | ----------- | -------- |
    | team          | 群信息         | 群信息      | 是       |
    | deleteMembers | List\<String\> | 踢的人的pin | 是       |

    - 退群通知

    | 参数名        | 参数类型       | 说明          | 是否必填 |
    | ------------- | -------------- | ------------- | -------- |
    | team          | 群信息         | 群信息        | 是       |
    | deleteMembers | List\<String\> | 退群的人的pin | 是       |

    - 设置管理员通知

    | 参数名    | 参数类型 | 说明        | 是否必填 |
    | --------- | -------- | ----------- | -------- |
    | fromId    | String   | 操作人pin   | 是       |
    | managerId | String   | 管理员的pin | 是       |

    - 解散群通知

    | 参数名 | 参数类型 | 说明   | 是否必填 |
    | ------ | -------- | ------ | -------- |
    | team   | 群信息   | 群信息 | 是       |

    - im用户更新资料

    | 参数名     | 参数类型 | 说明     | 是否必填 |
    | ---------- | -------- | -------- | -------- |
    | pin        | String   | 用户pin  | 是       |
    | appId      | String   | 应用id   | 是       |
    | nickname   | String   | 昵称     | 是       |
    | avatar     | String   | 头像     | 是       |
    | updateTime | Date     | 创建时间 | 是       |

  - 通知类消息
    - 同意好友申请

    | 参数名        | 参数类型 | 说明       | 是否必填 |
    | ------------- | -------- | ---------- | -------- |
    | applyId       | String   | 申请记录id | 是       |
    | agreeNickName | String   | 同意人昵称 | 是       |
    | applyNickName | String   | 申请人昵称 | 是       |
    | avatar        | String   | 头像       | 是       |
    | updateTime    | Date     | 创建时间   | 是       |

    - 消息置顶

    | 参数名  | 参数类型    | 说明     | 是否必填 |
    | ------- | ----------- | -------- | -------- |
    | chatId  | String      | 群id     | 是       |
    | msgList | MessageData | 消息信息 | 是       |

    - 群通知

    | 参数名       | 参数类型 | 说明         | 是否必填 |
    | ------------ | -------- | ------------ | -------- |
    | announceId   | String   | 通知id       | 是       |
    | announce     | String   | 通知内容     | 是       |
    | announceTime | Date     | 申请发布时间 | 是       |
    | pin          | String   | 发布人pin    | 是       |
    | appId        | String   | app id       | 是       |

    - 创建群

    | 参数名 | 参数类型 | 说明      | 是否必填 |
    | ------ | -------- | --------- | -------- |
    | fromId | String   | 创建人pin | 是       |
    | appId  | String   | app id    | 是       |

    - 入群

    | 参数名           | 参数类型 | 说明       | 是否必填 |
    | ---------------- | -------- | ---------- | -------- |
    | fromId           | String   | 操作人pin  | 是       |
    | appId            | String   | app id     | 是       |
    | members.pin      | String   | 加入人pin  | 是       |
    | members.nickname | String   | 加入人昵称 | 是       |

    - 踢人出群

    | 参数名           | 参数类型 | 说明       | 是否必填 |
    | ---------------- | -------- | ---------- | -------- |
    | fromId           | String   | 操作人pin  | 是       |
    | appId            | String   | app id     | 是       |
    | members.pin      | String   | 加入人pin  | 是       |
    | members.nickname | String   | 加入人昵称 | 是       |

    - 退群

    | 参数名 | 参数类型 | 说明      | 是否必填 |
    | ------ | -------- | --------- | -------- |
    | fromId | String   | 退群人pin | 是       |
    | appId  | String   | app id    | 是       |

    - 设置群管理员

    | 参数名    | 参数类型 | 说明      | 是否必填 |
    | --------- | -------- | --------- | -------- |
    | fromId    | String   | 操作人pin | 是       |
    | appId     | String   | app id    | 是       |
    | managerId | String   | 管理员pin | 是       |

    - 群禁言

    | 参数名 | 参数类型 | 说明      | 是否必填 |
    | ------ | -------- | --------- | -------- |
    | fromId | String   | 操作人pin | 是       |
    | appId  | String   | app id    | 是       |

    - 取消群禁言

    | 参数名 | 参数类型 | 说明      | 是否必填 |
    | ------ | -------- | --------- | -------- |
    | fromId | String   | 操作人pin | 是       |
    | appId  | String   | app id    | 是       |

    - 禁止群成员间添加好友

    | 参数名 | 参数类型 | 说明      | 是否必填 |
    | ------ | -------- | --------- | -------- |
    | fromId | String   | 操作人pin | 是       |
    | appId  | String   | app id    | 是       |

    - 取消禁止群成员间添加好友

    | 参数名 | 参数类型 | 说明      | 是否必填 |
    | ------ | -------- | --------- | -------- |
    | fromId | String   | 操作人pin | 是       |
    | appId  | String   | app id    | 是       |

    - 删除群

    | 参数名 | 参数类型 | 说明      | 是否必填 |
    | ------ | -------- | --------- | -------- |
    | fromId | String   | 操作人pin | 是       |
    | appId  | String   | app id    | 是       |

    - 群更新

    | 参数名                         | 参数类型 | 说明                 | 是否必填 |
    | ------------------------------ | -------- | -------------------- | -------- |
    | id                             | String   | 群id                 | 是       |
    | appId                          | String   | app id               | 是       |
    | tname                          | String   | 群名称               | 是       |
    | icon                           | String   | 群头像               | 是       |
    | owner                          | String   | 群主pin              | 是       |
    | announce                       | String   | 公告内容             | 是       |
    | announceTime                   | Date     | 群公告更新时间       | 是       |
    | announceId                     | String   | 群公告id             | 是       |
    | mute                           | Boolean  | 是否群禁言           | 是       |
    | forbidFriend                   | Boolean  | 是否禁止加好友       | 是       |
    | inviteAble                     | Boolean  | 是否能邀请用户进群   | 是       |
    | createTime                     | Date     | 创建时间             | 是       |
    | createTimeMilliseconds         | uint64   | 创建时间戳           | 是       |
    | updateTimeMilliseconds         | uint64   | 修改时间戳           | 是       |
    | teamUserUpdateTimeMilliseconds | uint64   | 群用户更新时间戳     | 是       |
    | canAddByQrcode                 | Boolean  | 是否能通过二维码入群 | 是       |
    | canAddMeShortLink              | Boolean  | 是否能通过短链接入群 | 是       |

  - 会话消息
    - 用户登录信息

    | 参数名   | 参数类型 | 说明                     | 是否必填 |
    | -------- | -------- | ------------------------ | -------- |
    | pin      | String   | 用户pin                  | 是       |
    | uid      | String   | 用户uid                  | 是       |
    | nickname | String   | 昵称                     | 是       |
    | avatar   | String   | 头像                     | 是       |
    | isBot    | String   | 是否是机器人             | 是       |
    | sex      | Boolean  | 性别，true:男；false：女 | 是       |

    - 音频消息

    | 参数名 | 参数类型 | 说明        | 是否必填 |
    | ------ | -------- | ----------- | -------- |
    | md5    | String   | 文件md5     | 是       |
    | url    | String   | 音频url地址 | 是       |
    | size   | String   | 文件大小    | 是       |

    - 表情消息

    | 参数名    | 参数类型 | 说明     | 是否必填 |
    | --------- | -------- | -------- | -------- |
    | emoji     | String   | 表情地址 | 是       |
    | emojiName | String   | 表情名称 | 是       |

    - 文件消息

    | 参数名   | 参数类型 | 说明        | 是否必填 |
    | -------- | -------- | ----------- | -------- |
    | md5      | String   | 文件md5     | 是       |
    | url      | String   | 文件url地址 | 是       |
    | size     | String   | 文件大小    | 是       |
    | fileName | String   | 文件名称    | 是       |

    - 图片消息

    | 参数名   | 参数类型 | 说明        | 是否必填 |
    | -------- | -------- | ----------- | -------- |
    | md5      | String   | 文件md5     | 是       |
    | url      | String   | 文件url地址 | 是       |
    | size     | String   | 文件大小    | 是       |
    | fileName | String   | 文件名称    | 是       |
    | ext      | String   | 扩展名      | 是       |
    | w        | int      | 宽          | 是       |
    | h        | int      | 高          | 是       |

    - @回复消息

    | 参数名     | 参数类型       | 说明             | 是否必填 |
    | ---------- | -------------- | ---------------- | -------- |
    | pins       | List\<String\> | 被@的pins        | 是       |
    | replyMsgId | String         | 被回复的消息id   | 是       |
    | replyMsg   | String         | 被回复的消息     | 是       |
    | replyType  | String         | 被回复的消息类型 | 是       |
    | msg        | String         | 消息             | 是       |

    - 回复消息

    | 参数名     | 参数类型 | 说明             | 是否必填 |
    | ---------- | -------- | ---------------- | -------- |
    | replyMsgId | String   | 被回复的消息id   | 是       |
    | replyMsg   | String   | 被回复的消息     | 是       |
    | replyType  | String   | 被回复的消息类型 | 是       |
    | msg        | String   | 消息             | 是       |

    - @某人消息

    | 参数名 | 参数类型       | 说明     | 是否必填 |
    | ------ | -------------- | -------- | -------- |
    | pins   | List\<String\> | 被@的pin | 是       |
    | msg    | String         | 消息     | 是       |

    - 文本消息

    | 参数名 | 参数类型 | 说明 | 是否必填 |
    | ------ | -------- | ---- | -------- |
    | msg    | String   | 消息 | 是       |

    - 视频消息

    | 参数名 | 参数类型 | 说明            | 是否必填 |
    | ------ | -------- | --------------- | -------- |
    | md5    | String   | 文件md5         | 是       |
    | url    | String   | 视频文件url地址 | 是       |
    | size   | String   | 文件大小        | 是       |

    - 二维码消息

    | 参数名 | 参数类型 | 说明             | 是否必填 |
    | ------ | -------- | ---------------- | -------- |
    | qr     | String   | 二维码加密字符串 | 是       |
