# 弱网处理备忘录

Author: qians

Date: 2023/5/16

Version: 0.0.1

## 说明

本文档只是对我之前处理弱网处理的回忆和整理, 并不是为当前项目提出的完善方案, 但我认为经验是相互的, 抛砖引玉, 做为参考.
首先抛出一个暴论: **弱网是没有办法解决的, 弱网只能事后补偿.**

因为弱网是一个纯粹的现实情况, 你不可能让一个信号不好的手机, 突然信号就好起来, 他网络就是慢, 就是卡, 你也不可能让他快起来. 所以我们能做到只有一点, 那就是在他弱网的时候, 不要放弃, 等他信号好起来了, 再把东西尽快推给他.

## 思路

> 由于我个人技术栈的因素, 所以之前的设计上, 绝大部分都是服务器来处理, 客户端只做配合.

### 分析

想要解决问题, 首先应该分析问题.
造成弱网的原因多种多样, 但是表现出来的现象是很相似的:

- 对服务器请求丢失(发).
- 服务器推送丢失(收).
- 请求延迟暴增.

既然知道了问题那么一个个尝试解决就好.

#### 对服务器请求丢失(发)/服务器推送丢失(收)

其实收发的丢包是一回事, 只是双方互换位置而已. 解决方法也是一样的:

- 确认
- 重试

##### 发

对于客户端, 客户端发送请求给服务端, 服务端收到请求后, 给客户端返回一个ACK, 表明以收到请求.
如果客户端没有收到ACK, 那么则客户端可以认为本请求丢失了, 应该进行重发. 重发延时遵循指数级递增, 例如1s -> 2s -> 5s -> 10s -> 30s -> ..., 直至到达最大重试次数或时间后直接断开连接尝试重连.

对于服务端, 需要保证请求的幂等性(同一个请求, 请求无数次也是一个效果). 举个例子就是极端情况下客户端弱网发消息, 重试无数次, 服务器收到, 但ACK没收到, 所以客户端一直重试, 服务器要保证这些消息最多只是一条, 不会裂变成多条.

#### 收

收和发其实是一摸一样的处理, 只是双方互换, 变成服务端推送, 客户端ACK, 服务端未收到ACK则重试, 客户端保证幂等性(去重).

#### Q&A

为了方便表达, 我将发送方称为: **上游**, ACK方称为: **下游**.

1. 如果ACK也丢失呢?
ACK丢失其实并不影响, 因为如果未收到ACK, 则上游会认为丢包了, 进行重发. 只要有一次重发的ACK收到了即可, 最终依然保证了消息的必达.

2. 可是这不是加重了服务器的负担吗?
没错, 是这样的, 但是在系统设计中, 所有的高可用, 都是通过冗余, 通过牺牲一部分性能来达到的. 我认为只要做好取舍即可, 通常来说这是可接受的.

3. 那这块逻辑可以单独封装一个中间件, 而不是继续追加协议吗?
可以, 实际上之前我的做法是封装了一个定时任务的中间件(CountDown). 上游可以直接把任务丢给CountDown, CountDown将数据推向Kafka, 下游收到后, 通过HTTP或其他向CountDown进行ACK去注销任务. 否则CountDown或按照延时设置不停的触发推送, 直至达成条件(ACK, 超时, 超过尝试次数).

#### 请求延迟暴增

对于这个情况, 我之前没有去处理, 因为当时的版本, 我们没有Http/Https请求. 都是走的Grpc, 所以遇到的不多. 只是也有所研究.

处理的方法其实挺粗暴, 就是做HttpDNS.

首先说明, HttpDNS不是一个仅针对弱网的技术, 他的用处是全面降低http访问的延迟.

#### 原理

理解HttpDns为什么有用, 首先我们需要理解发起一次请求, 到底做了什么.
简单来说, 三步:

1. 解析域名.
2. 访问ip.
3. 收发数据然后断开.

这其中的2, 3步, 我们都无法干涉. 所以理所当然是在解析域名的时候做些手脚.
这里为啥要去动域名解析的过程, 这不是一个标准吗. 其实也挺无奈的, 因为国内网络环境很差, 加之DNS默认使用udp协议, 运营啥还会劫持DNS, 为了节省资源直接指向别的运营商的DNS, 导致比如成都地区的用户被分配到北京机房, 延迟肯定会增加啊.

#### 解决办法

解决办法也和简单, 不走运营商的DNS, 直接通过Http访问一个权威的HTTPDNS服务得到一个服务器的IP地址, 然后之后的访问都直接通过此IP访问, 没有中间商赚差价.
因此直接带来了以下好处:

1. 避免了Local DNS 劫持: 由于 HttpDns 是通过 IP 直接请求 HTTP 获取服务器 A 记录地址, 不存在向本地运营商询问 domain 解析过程, 所以从根本避免了劫持问题.

2. 平均访问延迟下降: 由于是 IP 直接访问省掉了一次 domain 解析过程, 通过智能算法排序后找到最快节点进行访问.

3. 用户连接失败率下降: 通过算法降低以往失败率过高的服务器排序, 通过时间近期访问过的数据提高服务器排序, 通过历史访问成功记录提高服务器排序.

#### 集成

HttpDNS服务各大云平台都有通过, 前期直接购买相关服务即可. 后期可以自研. 原理很简单, 实现不算难. 当然想做好还是要花些功夫的.
